
let craftingData = [
  {
    name:"Stasis Device",
    value: 15600000,
    resources: [
      {
        name:"Quantum Processor",
        qty: 1
      },
      {
        name:"Cryogenic Chamber",
        qty: 1
      },
      {
        name: "Iridesite",
        qty: 1
      }
    ]
  },
  {
    name: "Fusion Ignitor",
    value: 15600000,
    resources: [
      {
        name: "Quantum Processor",
        qty: 1
      },
      {
        name: "Portable Reactor",
        qty: 1
      },
      {
        name: "Geodesite",
        qty: 1
      }
    ]
  },
  {
    name: "Quantum Processor",
    value: 5200000,
    resources: [
      {
        name: "Circuit Board",
        qty: 1
      },
      {
        name: "Superconductor",
        qty: 1
      }
    ]
  },
  {
    name: "Portable Reactor",
    value: 4200000,
    resources: [
      {
        name: "Liquid Explosive",
        qty: 1
      },
      {
        name: "Fusion Accelerant",
        qty: 1
      }
    ]
  },
  {
    name: "Cryogenic Chamber",
    value: 3800000,
    resources: [
      {
        name: "Living Glass",
        qty: 1
      },
      {
        name: "Cryo-Pump",
        qty: 1
      }
    ]
  },
  {
    name: "Superconductor",
    value: 2000000,
    resources: [
      {
        name: "Semiconductor",
        qty: 1
      },
      {
        name: "Enriched Carbon",
        qty: 1
      }
    ]
  },
  {
    name: "Cryo-Pump",
    value: 1500000,
    resources: [
      {
        name: "Thermic Condensate",
        qty: 1
      },
      {
        name: "Hot Ice",
        qty: 1
      }
    ]
  },
  {
    name: "Fusion Accelerant",
    value: 1500000,
    resources: [
      {
        name: "Organic Catalyst",
        qty: 1
      },
      {
        name: "Nitrogen Salt",
        qty: 1
      }
    ]
  },
  {
    name: "Circuit Board",
    value: 916250,
    resources: [
      {
        name: "Poly Fibre",
        qty: 1
      },
      {
        name: "Heat Capacitor",
        qty: 1
      }
    ]
  },
  {
    name: "Liquid Explosive",
    value: 800500,
    resources: [
      {
        name: "Acid",
        qty: 1
      },
      {
        name: "Unstable Gel",
        qty: 1
      }
    ]
  },
  {
    name: "Living Glass",
    value: 566000,
    resources: [
      {
        name: "Glass",
        qty: 5
      },
      {
        name: "Lubricant",
        qty: 1
      }
    ]
  },
  {
    name: "Semiconductor",
    value: 400000,
    resources: [
      {
        name: "Nitrogen Salt",
        qty: 1
      },
      {
        name: "Thermic Condensate",
        qty: 1
      }
    ]
  },
  {
    name: "Hot Ice",
    value: 400000,
    resources: [
      {
        name: "Enriched Carbon",
        qty: 1
      },
      {
        name: "Nitrogen Salt",
        qty: 1
      }
    ]
  },
  {
    name:"Organic Catalyst",
    value: 320000,
    resources: [
      {
        name: "Thermic Condensate",
        qty: 1
      },
      {
        name: "Enriched Carbon",
        qty: 1
      }
    ]
  },
  {
    name: "Acid",
    value: 188000,
    resources: [
      {
        name: "Mordite",
        qty: 25
      },
      {
        name: "Fungal Mould",
        qty: 600
      }
    ]
  },
  {
    name: "Heat Capacitor",
    value: 180000,
    resources: [
      {
        name: "Solanium",
        qty: 200
      },
      {
        name: "Frost Crystal",
        qty: 100
      }
    ]
  },
  {
    name: "Grantine",
    value: 150000,
    resources: [
      {
        name: "Ionised Cobalt",
        qty: 50
      },
      {
        name: "Dioxite",
        qty: 50
      }
    ]
  },
  {
    name: "Geodesite",
    value: 150000,
    resources: [
      {
        name: "Dirty Bronze",
        qty: 1
      },
      {
        name: "Herox",
        qty: 1
      },
      {
        name: "Lemmium",
        qty: 1
      }
    ]
  },
  {
    name: "Iridesite",
    value: 150000,
    resources: [
      {
        name: "Aronium",
        qty: 1
      },
      {
        name: "Magno-Gold",
        qty: 1
      },
      {
        name: "Grantine",
        qty: 1
      }
    ]
  },
  {
    name: "Poly Fibre",
    value: 130000,
    resources: [
      {
        name: "Cactus Flesh",
        qty: 100
      },
      {
        name: "Star Bulb",
        qty: 200
      }
    ]
  },
  {
    name: "Lubricant",
    value: 110000,
    resources: [
      {
        name: "Faecium",
        qty: 50
      },
      {
        name: "Gamma Root",
        qty: 400
      }
    ]
  },
  {
    name: "Nitrogen Salt",
    value: 50000,
    resources: [
      {
        name: "Condensed Carbon",
        qty: 50
      },
      {
        name: "Radon",
        qty: 250
      }
    ]
  },
  {
    name: "Enriched Carbon",
    value: 50000,
    resources: [
      {
        name: "Condensed Carbon",
        qty: 50
      },
      {
        name: "Radon",
        qty: 250
      }
    ]
  },
  {
    name: "Thermic Condensate",
    value: 50000,
    resources: [
      {
        name: "Condensed Carbon",
        qty: 50
      },
      {
        name: "Sulphurine",
        qty: 250
      }
    ]
  },
  {
    name: "Unstable Gel",
    value: 50000,
    resources: [
      {
        name: "Cactus Flesh",
        qty: 200
      }
    ]
  },
  {
    name: "Warp Cell",
    value: 46750,
    resources: [
      {
        name: "Antimatter Housing",
        qty: 1
      },
      {
        name: "Antimatter",
        qty: 1
      }
    ]
  },
  {
    name: "Warp Hypercore",
    value: 46750,
    resources: [
      {
        name: "Antimatter",
        qty: 1
      },
      {
        name: "Storm Crystal",
        qty: 1
      }
    ]
  },
  {
    name: "Lemmium",
    value: 25000,
    resources: [
      {
        name: "Uranium",
        qty: 1
      },
      {
        name: "Pure Ferrite",
        qty: 1
      }
    ]
  },
  {
    name: "Dirty Bronze",
    value: 25000,
    resources: [
      {
        name: "Pyrite",
        qty: 1
      },
      {
        name: "Pure Ferrite",
        qty: 1
      }
    ]
  },
  {
    name: "Magno-Gold",
    value: 25000,
    resources: [
      {
        name: "Ionised Cobalt",
        qty: 50
      },
      {
        name: "Phosphorus",
        qty: 1
      }
    ]
  },
  {
    name: "Aronium",
    value: 25000,
    resources: [
      {
        name: "Ionised Cobalt",
        qty: 50
      },
      {
        name: "Paraffinium",
        qty: 50
      }
    ]
  },
  {
    name: "Herox",
    value: 25000,
    resources: [
      {
        name: "Ammonia",
        qty: 1
      },
      {
        name: "Ionised Cobalt",
        qty: 1
      }
    ]
  },
  {
    name: "Amino Chamber",
    value: 12300,
    resources: [
      {
        name: "Metal Plating",
        qty: 1
      },
      {
        name: "Chlorine",
        qty: 20
      },
      {
        name: "Condensed Carbon",
        qty: 25
      }
    ]
  },
  {
    name: "Antimatter Housing",
    value: 6500,
    resources: [
      {
        name: "Oxygen",
        qty: 30
      },
      {
        name: "Ferrite Dust",
        qty: 50
      }
    ]
  },
  {
    name: "Magnetic Resonator",
    value: 6150,
    resources: [
      {
        name: "Magnetised Ferrite",
        qty: 40
      },
      {
        name: "Ionised Cobalt",
        qty: 40
      }
    ]
  },
  {
    name: "Solar Mirror",
    value: 6150,
    resources: [
      {
        name: "Gold",
        qty: 40
      },
      {
        name: "Silver",
        qty: 30
      },
      {
        name: "Chromatic Metal",
        qty: 25
      }
    ]
  },
  {
    name: "Antimatter",
    value: 5233,
    resources: [
      {
        name: "Chromatic Metal",
        qty: 25
      },
      {
        name: "Condensed Carbon",
        qty: 20
      }
    ]
  },
  {
    name: "Quantum Computer",
    value: 4200,
    resources: [
      {
        name: "Microprocessor",
        qty: 1
      },
      {
        name: "Antimatter",
        qty: 1
      },
      {
        name: "Chromatic Metal",
        qty: 25
      }
    ]
  },
  {
    name: "Hydraulic Wiring",
    value: 3600,
    resources: [
      {
        name: "Carbon Nanotubes",
        qty: 2
      },
      {
        name: "Salt",
        qty: 20
      },
      {
        name: "Di-hydrogen",
        qty: 40
      }
    ]
  },
  {
    name: "AtlasPass v3",
    value: 2613,
    resources: [
      {
        name: "Emeril",
        qty: 200
      },
      {
        name: "Microprocessor",
        qty: 1
      }
    ]
  },
  {
    name: "Microprocessor",
    value: 2000,
    resources: [
      {
        name: "Chromatic Metal",
        qty: 40
      },
      {
        name: "Carbon Nanotubes",
        qty: 1
      }
    ]
  },
  {
    name: "AtlasPass v2",
    value: 1856,
    resources: [
      {
        name: "Cadmium",
        qty: 200
      },
      {
        name: "Microprocessor",
        qty: 1
      }
    ]
  },
  {
    name: "AtlasPass v1",
    value: 825,
    resources: [
      {
        name: "Copper",
        qty: 200
      },
      {
        name: "Microprocessor",
        qty: 1
      }
    ]
  },
  {
    name: "Metal Plating",
    value: 800,
    resources: [
      {
        name: "Ferrite Dust",
        qty: 50
      }
    ]
  },
  {
    name: "Hermetic Seal",
    value: 800,
    resources: [
      {
        name: "Condensed Carbon",
        qty: 30
      }
    ]
  },
  {
    name: "Carbon Nanotubes",
    value: 500,
    resources: [
      {
        name: "Carbon",
        qty: 50
      }
    ]
  },
  {
    name: "Glass",
    value: 200,
    resources: [
      {
        name: "Frost Crystal",
        qty: 40
      }
    ]
  },
  {
    name: "Di-hydrogen Jelly",
    value: 200,
    resources: [
      {
        name: "Di-hydrogen",
        qty: 40
      }
    ]
  },
  {
    name:"Ion Battery",
    value: 200,
    resources: [
      {
        name: "Ferrite Dust",
        qty: 20
      },
      {
        name: "Cobalt",
        qty: 10
      }
    ]
  },
  {
    name:"Life Support Gel",
    value: 200,
    resources: [
      {
        name: "Di-hydrogen Jelly",
        qty: 1
      },
      {
        name:"Carbon",
        qty: 20
      }
    ]
  }
];

let rawMaterials = [
  {
    name: "Ammonia",
    value: 62
  },
  {
    name: "Cactus Flesh",
    value: 28
  },
  {
    name: "Cadmium",
    value: 234
  },
  {
    name: "Carbon",
    value: 7
  },
  {
    name: "Chlorine",
    value: 602
  },
  {
    name: "Chromatic Metal",
    value: 245
  },
  {
    name: "Cobalt",
    value: 198
  },
  {
    name: "Condensed Carbon",
    value: 24
  },
  {
    name: "Copper",
    value: 110
  },
  {
    name: "Di-hydrogen",
    value: 34
  },
  {
    name: "Dioxite",
    value: 62
  },
  {
    name: "Emeril",
    value: 275
  },
  {
    name: "Faecium",
    value: 30
  },
  {
    name: "Ferrite Dust",
    value: 14
  },
  {
    name: "Frost Crystal",
    value: 12
  },
  {
    name: "Fungal Mould",
    value: 16
  },
  {
    name: "Gamma Root",
    value: 16
  },
  {
    name: "Gold",
    value: 202
  },
  {
    name: "Ionised Cobalt",
    value: 401
  },
  {
    name: "Magnetised Ferrite",
    value: 82
  },
  {
    name: "Mordite",
    value: 40
  },
  {
    name: "Oxygen",
    value: 34
  },
  {
    name: "Paraffinium",
    value: 62
  },
  {
    name: "Phosphorus",
    value: 62
  },
  {
    name: "Pure Ferrite",
    value: 28
  },
  {
    name: "Pyrite",
    value: 62
  },
  {
    name: "Radon",
    value: 20
  },
  {
    name: "Salt",
    value: 299
  },
  {
    name: "Silver",
    value: 101
  },
  {
    name: "Solanium",
    value: 70
  },
  {
    name: "Star Bulb",
    value: 32
  },
  {
    name: "Storm Crystal",
    value: 156950
  },
  {
    name: "Sulphurine",
    value: 20
  },
  {
    name: "Uranium",
    value: 62 }
];

function init() {
  let item = itemNameFromParams();

  if (searchForComponent(item)) {
    shoppingList(item);
  } else {
    indexPage();
  }
}

// routing logic

function itemNameFromParams() {
  let params = new URL(document.location).searchParams;
  return params.get("item");
}

// Presentation section:

// Pages

function indexPage(data = craftingData) {
  let table = displayElement('', 'table');

  var headings = ["<b>Item</b>", "<b>Value</b>"];
  addTableHeading(headings, table);

  data.forEach( row => {
    var {name, value} = row;
    var cells = [`<a href="/?item=${name}">${name}</a>`, numberWithCommas(value)];
    addTableRow(cells, table);
  });
}

function shoppingList(item) {
  var component = buildComponentTree(item);
  var head = `
<h1>${component.name}</h1>
<p class="component-value units">value ${numberWithCommas(component.value)}
<p class="component-profit units">profit ${numberWithCommas(component.profit)}
<p class="component-cost units">cost ${numberWithCommas(component.rawMaterialsTotalCost)}
<p>
  <em>After harvesting the <a href="#raw_materials">raw materials</a>, craft components in the order listed. See the <a href="#graph">construction overview</a> for a visualisation of the component resources</em>
</p>
  `;
  displayTemplate(head);

  if(component.craftable.length > 0) {
    displayElement("Craftable Components", "h2");

    // Craftable shopping list...
    let componentTable = displayResourcesTable(null, document.body, ["Component", "Quantity", "Cost"]);
    showResources(component.aggregatedComponents, componentTable);
  }

  displayElement(`<a name="raw_materials"></a>`);
  displayElement(`<a name="raw_materials"></a>Raw materials`, "h2");
  showRawMaterials(item);

  displayElement("Construction Overview", "h2#graph");
  renderDotGraph(item);
}

function showResources(resources, table) {
  resources.forEach(
    (resource) => {
      if(resource) {
        addTableRow([`<a href="/?item=${resource.name}">${resource.name}</a>`, resource.qty, numberWithCommas(resource.cost)], table);
      };
    }
  );
}

function showRawMaterials(item){
  let componentTree = buildComponentTree(item);

  displayResourcesTable(
    componentTree.aggregatedRawMaterials.concat(
      [
        {name: "<b>Total Cost</b>", qty: "", cost: `<b>${numberWithCommas(componentTree.rawMaterialsTotalCost)}</b>`},
        {name: "<b>Profit</b>", qty: "", cost: `<b>${numberWithCommas(componentTree.profit)}</b`}
      ]
    ));
}

// Data functions...

function searchForComponent(item, data = craftingData) {
  var found = data.find((product, index) => product.name == item);
  if (found) {
    return JSON.parse(JSON.stringify(found)); // use JSON to deep copy the found component (never mutate craftingData!)
  } else {
    return undefined;
  }
}

function buildComponentTree(componentName, root = undefined, quantity = 1) {
  let component = searchForComponent(componentName);

  let resourceTree = {
    name: component.name,
    value: component.value,
    craftable: filterOnCraftable(component.resources),
    rawMaterials: filterOnRawMaterials(component.resources),
    aggregatedRawMaterials: [],
    aggregatedComponents: []
  };

  if(root === undefined) root = resourceTree;

  if(resourceTree.craftable.length > 0) {
    resourceTree.craftable.map( i => {
      i.value = searchForComponent(i.name).value;
      i.cost = i.qty * i.value;

      root.aggregatedComponents.push({
        name: i.name,
        cost: i.cost,
        value: i.value,
        qty: i.qty
      });

      return i;
    });

    resourceTree.craftable.forEach( i => {
      let subTree = buildComponentTree(i.name, root, i.qty);
      i.craftable = subTree.craftable;
      i.rawMaterials = subTree.rawMaterials;
    });
  }

  if(resourceTree.rawMaterials.length > 0) {
    resourceTree.rawMaterials.map( i => {
      i.value = rawMaterials.find( e => i.name == e.name ).value;
      i.qty *= quantity;
      i.cost = i.value  * i.qty;

      root.aggregatedRawMaterials.push({
        name: i.name,
        qty: i.qty,
        cost: i.cost,
        value: i.value
      });

      return i;
    });
  }

  if(root.name == component.name) {
    root.aggregatedComponents = root.aggregatedComponents.reduce(reduceOnName, []).reverse();
    root.aggregatedRawMaterials = root.aggregatedRawMaterials.reduce(reduceOnName, []).sort(orderByName);
    root.rawMaterialsTotalCost = root.aggregatedRawMaterials.reduce((p,c) => p + c.cost, 0);

    root.profit = root.value - root.rawMaterialsTotalCost;
  }

  return resourceTree;
}

function reduceOnName(p, c) {

  let i = p?.findIndex(e => e.name === c.name);
  if(i > -1) {
    p[i].qty += c.qty;
    p[i].cost += c.cost;

    return p;
  }

  p?.push(c);

  return p;
}

function filterOnRawMaterials(resources) {
  return resources.filter( r => rawMaterials.map( e => e.name ).includes(r.name) );
}

function filterOnCraftable(resources) {
  return resources.filter( r => !rawMaterials.map( e => e.name ).includes(r.name) );
}

function orderByName(a, b) {
  return a.name > b.name ? 1 : -1;
}

function orderByValue(a, b) {
  return a.value > b.value ? 1 : -1;
}

function orderByCost(a, b) {
  return a.cost > b.cost ? 1 : -1;
}

// html helpers
function displayTemplate(template, container = document.body) {
  container.innerHTML += template;
}

function displayElement(text, htmlElementName = "p", container = document.body) {
  var element;
  let tagAndID = htmlElementName.split('#');
  let tagAndClassNames = tagAndID[0].split(".");

  if(tagAndClassNames[0] && tagAndClassNames[0] != '') {
     element = document.createElement(tagAndClassNames.shift());
  } else {
    element = document.createElement('div');
  }

  element.innerHTML = text;

  if(tagAndClassNames.length > 0) {
    element.className = tagAndClassNames.join(' ');
  }

  if (tagAndID[1]) {
    element.id = tagAndID[1];
  }

  container.appendChild(element);
  return element;
}

function displayHeading(text, container = document.body) {
  return displayElement(text, "h1", container);
}

function displayResourcesTable(items, container = document.body, headings = ["Component", "Quantity", "Cost"]) {
  var table = document.createElement("table");
  container.appendChild(table);

  addTableHeading(headings.map( it => `<b>${it}</b>` ), table);

  items?.forEach((i) => addTableRow([i.name, i.qty, numberWithCommas(i.cost)], table));

  return table;
}

function addTableHeading(cells, table) {
  var thead = document.createElement("thead");
  var tr = document.createElement("tr");

  cells.forEach((c) => {
    var th = document.createElement("th");
    th.innerHTML = c;
    tr.appendChild(th);
  });

  thead.appendChild(tr);
  table.appendChild(thead);
}

function addTableRow(cells, table) {
  var tr = document.createElement("tr");

  cells.forEach((c) => {
    var td = document.createElement("td");
    td.innerHTML = c;
    tr.appendChild(td);
  });

  table.appendChild(tr);
}

function numberWithCommas(n) {
  return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// graphing... generate graphviz directed graph

function generateDigraph(itemName) {
  let item = searchForComponent(itemName);

  if (item) {
    let graph = item.resources?.map( i => `"${itemName}" -> "${i.name}"` ).flat(2);
    graph.push( item.resources?.map(i => generateDigraph(i.name) ).flat(2));
    return graph.join(' ').replaceAll(",","").trim();
  }

  return undefined;
}

function generateNodeNames(itemName) {
  let item = searchForComponent(itemName);
  let graph = [itemName];

  if (item) {
    graph.push( item.resources.map(i => generateNodeNames(i.name) ));
  }

  return graph.flat(2);
}

function generateNodeList(itemName, nodeStyle = '[shape = box]') {
  let nodes =  generateNodeNames(itemName).map( n => `"${n}" ${nodeStyle}`);
  return nodes.join("\n");
}

function generateDotGraph(itemName) {
  let digraph = generateDigraph(itemName);
  let nodeList = generateNodeList(itemName);

  return `
    digraph  {
      graph [fontname = helvetica, splines = ortho ];
      node [fontname = helvetica];
      edge [fontname = helvetica, penwidth = 1, arrowhead = none, arrowtail = normal, dir = both, arrowsize = 0.6 ];

      ${nodeList}

      ${digraph.trim()}
    }
  `;

}

function renderDotGraph(itemName) {
  let viz = new Viz();

  viz.renderSVGElement(generateDotGraph(itemName))
    .then(function(element) {
      document.body.appendChild(element);
      element.id = 'svg_graph';

      element.removeAttribute('height');
      element.removeAttribute('width');
    })
    .catch(error => {
      viz = new Viz();

      console.error(error);
    });
}
