let craftingData = [
  {
    "name": "Stasis Device",
    "value": 15600000,
    "resources": [
      {
        "name": "Quantum Processor",
        "qty": 1
      },
      {
        "name": "Cryogenic Chamber",
        "qty": 1
      },
      {
        "name": "Iridesite",
        "qty": 1
      }
    ],
    "profit": 15461688,
    "profitMargin": 99.11338461538462,
    "profitMarkup": 11178.847822314767,
    "rawMaterialsTotalCost": 138312
  },
  {
    "name": "Fusion Ignitor",
    "value": 15600000,
    "resources": [
      {
        "name": "Quantum Processor",
        "qty": 1
      },
      {
        "name": "Portable Reactor",
        "qty": 1
      },
      {
        "name": "Geodesite",
        "qty": 1
      }
    ],
    "profit": 15521557,
    "profitMargin": 99.49716025641025,
    "profitMarkup": 19787.051744578865,
    "rawMaterialsTotalCost": 78443
  },
  {
    "name": "Quantum Processor",
    "value": 5200000,
    "resources": [
      {
        "name": "Circuit Board",
        "qty": 1
      },
      {
        "name": "Superconductor",
        "qty": 1
      }
    ],
    "profit": 5157000,
    "profitMargin": 99.17307692307692,
    "profitMarkup": 11993.023255813954,
    "rawMaterialsTotalCost": 43000
  },
  {
    "name": "Portable Reactor",
    "value": 4200000,
    "resources": [
      {
        "name": "Liquid Explosive",
        "qty": 1
      },
      {
        "name": "Fusion Accelerant",
        "qty": 1
      }
    ],
    "profit": 4165200,
    "profitMargin": 99.17142857142856,
    "profitMarkup": 11968.965517241379,
    "rawMaterialsTotalCost": 34800
  },
  {
    "name": "Cryogenic Chamber",
    "value": 3800000,
    "resources": [
      {
        "name": "Living Glass",
        "qty": 1
      },
      {
        "name": "Cryo-Pump",
        "qty": 1
      }
    ],
    "profit": 3771100,
    "profitMargin": 99.23947368421052,
    "profitMarkup": 13048.78892733564,
    "rawMaterialsTotalCost": 28900
  },
  {
    "name": "Superconductor",
    "value": 2000000,
    "resources": [
      {
        "name": "Semiconductor",
        "qty": 1
      },
      {
        "name": "Enriched Carbon",
        "qty": 1
      }
    ],
    "profit": 1981400,
    "profitMargin": 99.07000000000001,
    "profitMarkup": 10652.688172043012,
    "rawMaterialsTotalCost": 18600
  },
  {
    "name": "Cryo-Pump",
    "value": 1500000,
    "resources": [
      {
        "name": "Thermic Condensate",
        "qty": 1
      },
      {
        "name": "Hot Ice",
        "qty": 1
      }
    ],
    "profit": 1481400,
    "profitMargin": 98.76,
    "profitMarkup": 7964.516129032258,
    "rawMaterialsTotalCost": 18600
  },
  {
    "name": "Fusion Accelerant",
    "value": 1500000,
    "resources": [
      {
        "name": "Organic Catalyst",
        "qty": 1
      },
      {
        "name": "Nitrogen Salt",
        "qty": 1
      }
    ],
    "profit": 1481400,
    "profitMargin": 98.76,
    "profitMarkup": 7964.516129032258,
    "rawMaterialsTotalCost": 18600
  },
  {
    "name": "Circuit Board",
    "value": 916250,
    "resources": [
      {
        "name": "Poly Fibre",
        "qty": 1
      },
      {
        "name": "Heat Capacitor",
        "qty": 1
      }
    ],
    "profit": 891850,
    "profitMargin": 97.33697135061391,
    "profitMarkup": 3655.122950819672,
    "rawMaterialsTotalCost": 24400
  },
  {
    "name": "Liquid Explosive",
    "value": 800500,
    "resources": [
      {
        "name": "Acid",
        "qty": 1
      },
      {
        "name": "Unstable Gel",
        "qty": 1
      }
    ],
    "profit": 784300,
    "profitMargin": 97.97626483447846,
    "profitMarkup": 4841.358024691358,
    "rawMaterialsTotalCost": 16200
  },
  {
    "name": "Living Glass",
    "value": 566000,
    "resources": [
      {
        "name": "Glass",
        "qty": 5
      },
      {
        "name": "Lubricant",
        "qty": 1
      }
    ],
    "profit": 555700,
    "profitMargin": 98.18021201413427,
    "profitMarkup": 5395.145631067961,
    "rawMaterialsTotalCost": 10300
  },
  {
    "name": "Semiconductor",
    "value": 400000,
    "resources": [
      {
        "name": "Nitrogen Salt",
        "qty": 1
      },
      {
        "name": "Thermic Condensate",
        "qty": 1
      }
    ],
    "profit": 387600,
    "profitMargin": 96.89999999999999,
    "profitMarkup": 3125.8064516129034,
    "rawMaterialsTotalCost": 12400
  },
  {
    "name": "Hot Ice",
    "value": 400000,
    "resources": [
      {
        "name": "Enriched Carbon",
        "qty": 1
      },
      {
        "name": "Nitrogen Salt",
        "qty": 1
      }
    ],
    "profit": 387600,
    "profitMargin": 96.89999999999999,
    "profitMarkup": 3125.8064516129034,
    "rawMaterialsTotalCost": 12400
  },
  {
    "name": "Organic Catalyst",
    "value": 320000,
    "resources": [
      {
        "name": "Thermic Condensate",
        "qty": 1
      },
      {
        "name": "Enriched Carbon",
        "qty": 1
      }
    ],
    "profit": 307600,
    "profitMargin": 96.125,
    "profitMarkup": 2480.6451612903224,
    "rawMaterialsTotalCost": 12400
  },
  {
    "name": "Acid",
    "value": 188000,
    "resources": [
      {
        "name": "Mordite",
        "qty": 25
      },
      {
        "name": "Fungal Mould",
        "qty": 600
      }
    ],
    "profit": 177400,
    "profitMargin": 94.36170212765957,
    "profitMarkup": 1673.5849056603772,
    "rawMaterialsTotalCost": 10600
  },
  {
    "name": "Heat Capacitor",
    "value": 180000,
    "resources": [
      {
        "name": "Solanium",
        "qty": 200
      },
      {
        "name": "Frost Crystal",
        "qty": 100
      }
    ],
    "profit": 164800,
    "profitMargin": 91.55555555555556,
    "profitMarkup": 1084.2105263157896,
    "rawMaterialsTotalCost": 15200
  },
  {
    "name": "Grantine",
    "value": 150000,
    "resources": [
      {
        "name": "Ionised Cobalt",
        "qty": 50
      },
      {
        "name": "Dioxite",
        "qty": 50
      }
    ],
    "profit": 126850,
    "profitMargin": 84.56666666666666,
    "profitMarkup": 547.9481641468683,
    "rawMaterialsTotalCost": 23150
  },
  {
    "name": "Geodesite",
    "value": 150000,
    "resources": [
      {
        "name": "Dirty Bronze",
        "qty": 1
      },
      {
        "name": "Herox",
        "qty": 1
      },
      {
        "name": "Lemmium",
        "qty": 1
      }
    ],
    "profit": 149357,
    "profitMargin": 99.57133333333333,
    "profitMarkup": 23228.14930015552,
    "rawMaterialsTotalCost": 643
  },
  {
    "name": "Iridesite",
    "value": 150000,
    "resources": [
      {
        "name": "Aronium",
        "qty": 1
      },
      {
        "name": "Magno-Gold",
        "qty": 1
      },
      {
        "name": "Grantine",
        "qty": 1
      }
    ],
    "profit": 83588,
    "profitMargin": 55.72533333333334,
    "profitMarkup": 125.86279588026261,
    "rawMaterialsTotalCost": 66412
  },
  {
    "name": "Poly Fibre",
    "value": 130000,
    "resources": [
      {
        "name": "Cactus Flesh",
        "qty": 100
      },
      {
        "name": "Star Bulb",
        "qty": 200
      }
    ],
    "profit": 120800,
    "profitMargin": 92.92307692307692,
    "profitMarkup": 1313.0434782608695,
    "rawMaterialsTotalCost": 9200
  },
  {
    "name": "Lubricant",
    "value": 110000,
    "resources": [
      {
        "name": "Faecium",
        "qty": 50
      },
      {
        "name": "Gamma Root",
        "qty": 400
      }
    ],
    "profit": 102100,
    "profitMargin": 92.81818181818183,
    "profitMarkup": 1292.4050632911392,
    "rawMaterialsTotalCost": 7900
  },
  {
    "name": "Nitrogen Salt",
    "value": 50000,
    "resources": [
      {
        "name": "Condensed Carbon",
        "qty": 50
      },
      {
        "name": "Radon",
        "qty": 250
      }
    ],
    "profit": 43800,
    "profitMargin": 87.6,
    "profitMarkup": 706.4516129032259,
    "rawMaterialsTotalCost": 6200
  },
  {
    "name": "Enriched Carbon",
    "value": 50000,
    "resources": [
      {
        "name": "Condensed Carbon",
        "qty": 50
      },
      {
        "name": "Radon",
        "qty": 250
      }
    ],
    "profit": 43800,
    "profitMargin": 87.6,
    "profitMarkup": 706.4516129032259,
    "rawMaterialsTotalCost": 6200
  },
  {
    "name": "Thermic Condensate",
    "value": 50000,
    "resources": [
      {
        "name": "Condensed Carbon",
        "qty": 50
      },
      {
        "name": "Sulphurine",
        "qty": 250
      }
    ],
    "profit": 43800,
    "profitMargin": 87.6,
    "profitMarkup": 706.4516129032259,
    "rawMaterialsTotalCost": 6200
  },
  {
    "name": "Unstable Gel",
    "value": 50000,
    "resources": [
      {
        "name": "Cactus Flesh",
        "qty": 200
      }
    ],
    "profit": 44400,
    "profitMargin": 88.8,
    "profitMarkup": 792.8571428571429,
    "rawMaterialsTotalCost": 5600
  },
  {
    "name": "Warp Cell",
    "value": 46750,
    "resources": [
      {
        "name": "Antimatter Housing",
        "qty": 1
      },
      {
        "name": "Antimatter",
        "qty": 1
      }
    ],
    "profit": 38425,
    "profitMargin": 82.19251336898395,
    "profitMarkup": 461.5615615615615,
    "rawMaterialsTotalCost": 8325
  },
  {
    "name": "Warp Hypercore",
    "value": 46750,
    "resources": [
      {
        "name": "Antimatter",
        "qty": 1
      },
      {
        "name": "Storm Crystal",
        "qty": 1
      }
    ],
    "profit": -116805,
    "profitMargin": -249.85026737967914,
    "profitMarkup": -71.4163431261655,
    "rawMaterialsTotalCost": 163555
  },
  {
    "name": "Lemmium",
    "value": 25000,
    "resources": [
      {
        "name": "Uranium",
        "qty": 1
      },
      {
        "name": "Pure Ferrite",
        "qty": 1
      }
    ],
    "profit": 24910,
    "profitMargin": 99.64,
    "profitMarkup": 27677.777777777777,
    "rawMaterialsTotalCost": 90
  },
  {
    "name": "Dirty Bronze",
    "value": 25000,
    "resources": [
      {
        "name": "Pyrite",
        "qty": 1
      },
      {
        "name": "Pure Ferrite",
        "qty": 1
      }
    ],
    "profit": 24910,
    "profitMargin": 99.64,
    "profitMarkup": 27677.777777777777,
    "rawMaterialsTotalCost": 90
  },
  {
    "name": "Magno-Gold",
    "value": 25000,
    "resources": [
      {
        "name": "Ionised Cobalt",
        "qty": 50
      },
      {
        "name": "Phosphorus",
        "qty": 1
      }
    ],
    "profit": 4888,
    "profitMargin": 19.552,
    "profitMarkup": 24.30389817024662,
    "rawMaterialsTotalCost": 20112
  },
  {
    "name": "Aronium",
    "value": 25000,
    "resources": [
      {
        "name": "Ionised Cobalt",
        "qty": 50
      },
      {
        "name": "Paraffinium",
        "qty": 50
      }
    ],
    "profit": 1850,
    "profitMargin": 7.3999999999999995,
    "profitMarkup": 7.991360691144708,
    "rawMaterialsTotalCost": 23150
  },
  {
    "name": "Herox",
    "value": 25000,
    "resources": [
      {
        "name": "Ammonia",
        "qty": 1
      },
      {
        "name": "Ionised Cobalt",
        "qty": 1
      }
    ],
    "profit": 24537,
    "profitMargin": 98.148,
    "profitMarkup": 5299.5680345572355,
    "rawMaterialsTotalCost": 463
  },
  {
    "name": "Amino Chamber",
    "value": 12300,
    "resources": [
      {
        "name": "Metal Plating",
        "qty": 1
      },
      {
        "name": "Chlorine",
        "qty": 20
      },
      {
        "name": "Condensed Carbon",
        "qty": 25
      }
    ],
    "profit": -1040,
    "profitMargin": -8.455284552845528,
    "profitMarkup": -7.796101949025487,
    "rawMaterialsTotalCost": 13340
  },
  {
    "name": "Antimatter Housing",
    "value": 6500,
    "resources": [
      {
        "name": "Oxygen",
        "qty": 30
      },
      {
        "name": "Ferrite Dust",
        "qty": 50
      }
    ],
    "profit": 4780,
    "profitMargin": 73.53846153846155,
    "profitMarkup": 277.90697674418607,
    "rawMaterialsTotalCost": 1720
  },
  {
    "name": "Magnetic Resonator",
    "value": 6150,
    "resources": [
      {
        "name": "Magnetised Ferrite",
        "qty": 40
      },
      {
        "name": "Ionised Cobalt",
        "qty": 40
      }
    ],
    "profit": -13170,
    "profitMargin": -214.14634146341464,
    "profitMarkup": -68.16770186335404,
    "rawMaterialsTotalCost": 19320
  },
  {
    "name": "Solar Mirror",
    "value": 6150,
    "resources": [
      {
        "name": "Gold",
        "qty": 40
      },
      {
        "name": "Silver",
        "qty": 30
      },
      {
        "name": "Chromatic Metal",
        "qty": 25
      }
    ],
    "profit": -11085,
    "profitMargin": -180.2439024390244,
    "profitMarkup": -64.31679721496954,
    "rawMaterialsTotalCost": 17235
  },
  {
    "name": "Antimatter",
    "value": 5233,
    "resources": [
      {
        "name": "Chromatic Metal",
        "qty": 25
      },
      {
        "name": "Condensed Carbon",
        "qty": 20
      }
    ],
    "profit": -1372,
    "profitMargin": -26.218230460538887,
    "profitMarkup": -20.77214231642695,
    "rawMaterialsTotalCost": 6605
  },
  {
    "name": "Quantum Computer",
    "value": 4200,
    "resources": [
      {
        "name": "Microprocessor",
        "qty": 1
      },
      {
        "name": "Antimatter",
        "qty": 1
      },
      {
        "name": "Chromatic Metal",
        "qty": 25
      }
    ],
    "profit": -18680,
    "profitMargin": -444.76190476190476,
    "profitMarkup": -81.64335664335664,
    "rawMaterialsTotalCost": 22880
  },
  {
    "name": "Hydraulic Wiring",
    "value": 3600,
    "resources": [
      {
        "name": "Carbon Nanotubes",
        "qty": 2
      },
      {
        "name": "Salt",
        "qty": 20
      },
      {
        "name": "Di-hydrogen",
        "qty": 40
      }
    ],
    "profit": -4440,
    "profitMargin": -123.33333333333334,
    "profitMarkup": -55.223880597014926,
    "rawMaterialsTotalCost": 8040
  },
  {
    "name": "AtlasPass v3",
    "value": 2613,
    "resources": [
      {
        "name": "Emeril",
        "qty": 200
      },
      {
        "name": "Microprocessor",
        "qty": 1
      }
    ],
    "profit": -62537,
    "profitMargin": -2393.302717183314,
    "profitMarkup": -95.98925556408288,
    "rawMaterialsTotalCost": 65150
  },
  {
    "name": "Microprocessor",
    "value": 2000,
    "resources": [
      {
        "name": "Chromatic Metal",
        "qty": 40
      },
      {
        "name": "Carbon Nanotubes",
        "qty": 1
      }
    ],
    "profit": -8150,
    "profitMargin": -407.5,
    "profitMarkup": -80.29556650246306,
    "rawMaterialsTotalCost": 10150
  },
  {
    "name": "AtlasPass v2",
    "value": 1856,
    "resources": [
      {
        "name": "Cadmium",
        "qty": 200
      },
      {
        "name": "Microprocessor",
        "qty": 1
      }
    ],
    "profit": -55094,
    "profitMargin": -2968.426724137931,
    "profitMarkup": -96.74100087796312,
    "rawMaterialsTotalCost": 56950
  },
  {
    "name": "AtlasPass v1",
    "value": 825,
    "resources": [
      {
        "name": "Copper",
        "qty": 200
      },
      {
        "name": "Microprocessor",
        "qty": 1
      }
    ],
    "profit": -31325,
    "profitMargin": -3796.969696969697,
    "profitMarkup": -97.4339035769829,
    "rawMaterialsTotalCost": 32150
  },
  {
    "name": "Metal Plating",
    "value": 800,
    "resources": [
      {
        "name": "Ferrite Dust",
        "qty": 50
      }
    ],
    "profit": 100,
    "profitMargin": 12.5,
    "profitMarkup": 14.285714285714285,
    "rawMaterialsTotalCost": 700
  },
  {
    "name": "Hermetic Seal",
    "value": 800,
    "resources": [
      {
        "name": "Condensed Carbon",
        "qty": 30
      }
    ],
    "profit": 80,
    "profitMargin": 10,
    "profitMarkup": 11.11111111111111,
    "rawMaterialsTotalCost": 720
  },
  {
    "name": "Carbon Nanotubes",
    "value": 500,
    "resources": [
      {
        "name": "Carbon",
        "qty": 50
      }
    ],
    "profit": 150,
    "profitMargin": 30,
    "profitMarkup": 42.857142857142854,
    "rawMaterialsTotalCost": 350
  },
  {
    "name": "Glass",
    "value": 200,
    "resources": [
      {
        "name": "Frost Crystal",
        "qty": 40
      }
    ],
    "profit": -280,
    "profitMargin": -140,
    "profitMarkup": -58.333333333333336,
    "rawMaterialsTotalCost": 480
  },
  {
    "name": "Di-hydrogen Jelly",
    "value": 200,
    "resources": [
      {
        "name": "Di-hydrogen",
        "qty": 40
      }
    ],
    "profit": -1160,
    "profitMargin": -580,
    "profitMarkup": -85.29411764705883,
    "rawMaterialsTotalCost": 1360
  },
  {
    "name": "Ion Battery",
    "value": 200,
    "resources": [
      {
        "name": "Ferrite Dust",
        "qty": 20
      },
      {
        "name": "Cobalt",
        "qty": 10
      }
    ],
    "profit": -2060,
    "profitMargin": -1030,
    "profitMarkup": -91.1504424778761,
    "rawMaterialsTotalCost": 2260
  },
  {
    "name": "Life Support Gel",
    "value": 200,
    "resources": [
      {
        "name": "Di-hydrogen Jelly",
        "qty": 1
      },
      {
        "name": "Carbon",
        "qty": 20
      }
    ],
    "profit": -1300,
    "profitMargin": -650,
    "profitMarkup": -86.66666666666667,
    "rawMaterialsTotalCost": 1500
  }
];

let rawMaterials = [
  {
    name: 'Ammonia',
    value: 62
  },
  {
    name: 'Cactus Flesh',
    value: 28
  },
  {
    name: 'Cadmium',
    value: 234
  },
  {
    name: 'Carbon',
    value: 7
  },
  {
    name: 'Chlorine',
    value: 602
  },
  {
    name: 'Chromatic Metal',
    value: 245
  },
  {
    name: 'Cobalt',
    value: 198
  },
  {
    name: 'Condensed Carbon',
    value: 24
  },
  {
    name: 'Copper',
    value: 110
  },
  {
    name: 'Di-hydrogen',
    value: 34
  },
  {
    name: 'Dioxite',
    value: 62
  },
  {
    name: 'Emeril',
    value: 275
  },
  {
    name: 'Faecium',
    value: 30
  },
  {
    name: 'Ferrite Dust',
    value: 14
  },
  {
    name: 'Frost Crystal',
    value: 12
  },
  {
    name: 'Fungal Mould',
    value: 16
  },
  {
    name: 'Gamma Root',
    value: 16
  },
  {
    name: 'Gold',
    value: 202
  },
  {
    name: 'Ionised Cobalt',
    value: 401
  },
  {
    name: 'Magnetised Ferrite',
    value: 82
  },
  {
    name: 'Mordite',
    value: 40
  },
  {
    name: 'Oxygen',
    value: 34
  },
  {
    name: 'Paraffinium',
    value: 62
  },
  {
    name: 'Phosphorus',
    value: 62
  },
  {
    name: 'Pure Ferrite',
    value: 28
  },
  {
    name: 'Pyrite',
    value: 62
  },
  {
    name: 'Radon',
    value: 20
  },
  {
    name: 'Salt',
    value: 299
  },
  {
    name: 'Silver',
    value: 101
  },
  {
    name: 'Solanium',
    value: 70
  },
  {
    name: 'Star Bulb',
    value: 32
  },
  {
    name: 'Storm Crystal',
    value: 156950
  },
  {
    name: 'Sulphurine',
    value: 20
  },
  {
    name: 'Uranium',
    value: 62
  }
];

function init() {
  let item = itemNameFromParams();

  if (item && searchForComponent(item)) {
    shoppingList(item);
    return;
  }

  if (item) {
    rawMaterialsPage(item);
  } else {
    indexPage();
  }
}

// routing helper

function itemNameFromParams() {
  let params = new URL(document.location).searchParams;
  return params.get('item');
}

// Presentation section:

// Pages

function indexPage(data = craftingData, sort = 1, reverse = 'true') {
  let table = displayElement('', 'table#indexPage', selector('#content'));

  table.dataset.sort = sort;
  table.dataset.reverse = reverse;

  let headings = ['<b>Item</b>',
                  '<b>Value</b>',
                  '<b>Profit</b>',
                  '<b>Markup</b>',
                  '<b>Margin</b>'];
  let headingElements = addTableHeading(headings, table);

  Array.from(headingElements).forEach( th => th.onclick = reSortTable);

  let orderingFuncs = [
    orderByName,
    orderByValue,
    orderByProfit,
    orderByProfitMarkup,
    orderByProfitMargin
  ];

  let orderingFunc = orderingFuncs[sort];

  data = data.sort(orderingFunc);

  if (reverse) {
    data = data.reverse();
  }

  data.forEach( row => {
    var {
      name,
      value,
      profit,
      profitMarkup,
      profitMargin
    } = row;

    var cells = [
      `<a href='/?item=${name}'>${name}</a>`,
      numberWithCommas(value),
      numberWithCommas(profit),
      numberAsPercentage(profitMarkup),
      numberAsPercentage(profitMargin)
    ];

    addTableRow(cells, table);
  });
}

function shoppingList(item) {
  var component = buildComponentTree(item);
  var head = `
<h1>${component.name}</h1>
<p class='component-value units'>Value ${numberWithCommas(component.value)}u</p>
<p class='component-profit units'>Profit ${numberWithCommas(component.profit)}u / Margin: ${numberAsPercentage(component.profitMargin)} / Markup: ${numberAsPercentage(component.profitMarkup)}</p>
<p class='component-cost units'>Cost ${numberWithCommas(component.rawMaterialsTotalCost)}u</p>
<p><a href='https://nomanssky.fandom.com/wiki/${component.name}'>${component.name} on No Man's Sky Wiki</a></p>
<p>
  <em>After harvesting the <a href='#raw_materials'>raw materials</a>, craft components in the order listed. See the <a href='#graph'>construction overview</a> for a visualisation of the component resources</em>
</p>
  `;
  displayTemplate(head);

  if(component.craftable.length > 0) {
    displayElement('Craftable Components', 'h2');

    // Craftable shopping list...
    let componentTable = displayResourcesTable(null, document.body, ['Component', 'Quantity', 'Cost']);
    showResources(component.aggregatedComponents, componentTable);
  }

  displayElement(`<a name='raw_materials'></a>`);
  displayElement(`Raw Materials`, 'h2#raw_materials_title');
  showRawMaterials(item);

  displayElement('Construction Overview', 'h2#graph');
  displayElement(`<small><em>(graph nodes click through to components / raw materials...)</em></small>`, 'p');

  renderDotGraph(item);

}

function rawMaterialsPage(rawMaterial) {
  let value = rawMaterials.find( i => i.name == rawMaterial ).value;

  let head = `
<h1>${rawMaterial}</h1>
<p class='component-value units'>value ${numberWithCommas(value)}
<p><a href='https://nomanssky.fandom.com/wiki/${rawMaterial}'>${rawMaterial} on No Man's Sky Wiki</a></p>
  `;
  displayTemplate(head);
}

function showResources(resources, table) {
  resources.forEach(
    (resource) => {
      if(resource) {
        addTableRow([`<a href='/?item=${resource.name}'>${resource.name}</a>`, resource.qty, numberWithCommas(resource.cost)], table);
      };
    }
  );
}

function showRawMaterials(item){
  let componentTree = buildComponentTree(item);

  displayResourcesTable(
    componentTree.aggregatedRawMaterials,
    document.body,
    [
      'Raw Material',
      'Quantity',
      'Cost'
    ],
    [
      {
        name: '<b>Total Cost</b>',
        qty: '',
        cost: `<b>${numberWithCommas(componentTree.rawMaterialsTotalCost)}</b>`
      },
      {
        name: '<b>Net Profit</b>',
        qty: '',
        cost: `<b>${numberWithCommas(componentTree.profit)}</b>`
      },
      {
        name: '<b>Profit Markup</b>',
        qty: '',
        cost: `<b>${numberAsPercentage(componentTree.profitMarkup)}</b>`
      },
      {
        name: '<b>Profit Margin</b>',
        qty: '',
        cost: `<b>${numberAsPercentage(componentTree.profitMargin)}</b>`
      }
    ],
    'table#raw_materials'
    );
}

// Data functions...

function searchForComponent(item, data = craftingData) {
  var found = data.find((product, index) => product.name == item);
  if (found) {
    return JSON.parse(JSON.stringify(found)); // use JSON to deep copy the found component (never mutate craftingData!)
  } else {
    return undefined;
  }
}

function buildComponentTree(componentName, root = undefined, quantity = 1) {
  let component = searchForComponent(componentName);

  let resourceTree = {
    name: component.name,
    value: component.value,
    craftable: filterOnCraftable(component.resources),
    rawMaterials: filterOnRawMaterials(component.resources),
    aggregatedRawMaterials: [],
    aggregatedComponents: []
  };

  if(root === undefined) root = resourceTree;

  if(resourceTree.craftable.length > 0) {
    resourceTree.craftable.map( i => {
      i.value = searchForComponent(i.name).value;
      i.cost = i.qty * i.value;

      root.aggregatedComponents.push({
        name: i.name,
        cost: i.cost,
        value: i.value,
        qty: i.qty
      });

      return i;
    });

    resourceTree.craftable.forEach( i => {
      let subTree = buildComponentTree(i.name, root, i.qty);
      i.craftable = subTree.craftable;
      i.rawMaterials = subTree.rawMaterials;
    });
  }

  if(resourceTree.rawMaterials.length > 0) {
    resourceTree.rawMaterials.map( i => {
      i.value = rawMaterials.find( e => i.name == e.name ).value;
      i.qty *= quantity;
      i.cost = i.value  * i.qty;

      root.aggregatedRawMaterials.push({
        name: i.name,
        qty: i.qty,
        cost: i.cost,
        value: i.value
      });

      return i;
    });
  }

  if(root.name == component.name) {
    root.aggregatedComponents = root.aggregatedComponents.reduce(reduceOnName, []).reverse();
    root.aggregatedRawMaterials = root.aggregatedRawMaterials.reduce(reduceOnName, []).sort(orderByName);
    root.rawMaterialsTotalCost = root.aggregatedRawMaterials.reduce((p,c) => p + c.cost, 0);

    root.profit = root.value - root.rawMaterialsTotalCost;
    root.profitMargin = (root.profit / root.value) * 100;
    root.profitMarkup = (root.profit / root.rawMaterialsTotalCost) * 100;
  }

  return resourceTree;
}

function reduceOnName(p, c) {

  let f = p?.find(e => e.name === c.name);

  if(f) {
    f.qty += c.qty;
    f.cost += c.cost;

    return p;
  }

  p?.push(c);

  return p;
}

function filterOnRawMaterials(resources) {
  return resources.filter( r => rawMaterials.map( e => e.name ).includes(r.name) );
}

function filterOnCraftable(resources) {
  return resources.filter( r => !rawMaterials.map( e => e.name ).includes(r.name) );
}

function orderByName(a, b) {
  return orderByProperty(a, b, 'name');
}

function orderByValue(a, b) {
  return orderByProperty(a, b, 'value');
}

function orderByCost(a, b) {
  return orderByProperty(a, b, 'cost');
}

function orderByProfit(a, b) {
  return orderByProperty(a, b, 'profit');
}

function orderByProfitMarkup(a, b) {
  return orderByProperty(a, b, 'profitMarkup');
}

function orderByProfitMargin(a, b) {
  return orderByProperty(a, b, 'profitMargin');
}

function orderByProperty(a,b,prop) {
  return a[prop] > b[prop] ? 1 : -1;
}

function reSortTable(e) {
  let column = e.currentTarget;

  var table = e.currentTarget.parentElement;

  while( table == undefined || table.tagName != 'TABLE' ) {
    table = table.parentElement;
  }

  // get column index
  let row = column.parentElement;
  let sortIndex = Array.from(row.children).findIndex( th => th == column );

  // destroy the table
  table.remove();

  // re-render index page sorted, flip sort order (!reverse)
  indexPage(undefined, sortIndex, table.dataset.reverse != 'true');
}

// html helpers
function selector(selector) {
  return document.querySelector(selector);
}

function displayTemplate(template, container = document.body) {
  container.innerHTML += template;
}

function displayElement(text, htmlElementName = 'p', container = document.body) {
  var element;
  let tagAndID = htmlElementName.split('#');
  let tagAndClassNames = tagAndID[0].split('.');

  if(tagAndClassNames[0] && tagAndClassNames[0] != '') {
     element = document.createElement(tagAndClassNames.shift());
  } else {
    element = document.createElement('div');
  }

  element.innerHTML = text;

  if(tagAndClassNames.length > 0) {
    element.className = tagAndClassNames.join(' ');
  }

  if (tagAndID[1]) {
    element.id = tagAndID[1];
  }

  container.appendChild(element);
  return element;
}

function displayHeading(text, container = document.body) {
  return displayElement(text, 'h1', container);
}

function displayResourcesTable(items,
                               container = document.body,
                               headings = ['Component', 'Quantity', 'Cost'],
                               footerItems = undefined,
                               selector = 'table#resources_table' ) {

  var table = displayElement('', selector);
  container.appendChild(table);

  addTableHeading(headings.map( h => `<b>${h}</b>` ), table);

  items?.forEach((i) =>
    addTableRow([
      `<a href="/?item=${i.name}">${i.name}</a>`,
      i.qty,
      numberWithCommas(i.cost)
    ], table));

  if (footerItems) {
    addTableFooter(footerItems, table);
  }

  return table;
}

function addTableFooter(rows, table) {
  var tfoot = document.createElement('tfoot');

  rows.forEach((cell) => {
    var tr = document.createElement('tr');

    ['name', 'qty', 'cost'].forEach( column => {
      var th = document.createElement('th');
      if (column) th.innerHTML = cell[column];
      tr.appendChild(th);
    });

    tfoot.appendChild(tr);
  });

  table.appendChild(tfoot);

  return tfoot.children;
}

function addTableHeading(cells, table) {
  var thead = document.createElement('thead');
  var tr = document.createElement('tr');

  cells.forEach((c) => {
    var th = document.createElement('th');
    th.innerHTML = c;
    tr.appendChild(th);
  });

  thead.appendChild(tr);
  table.appendChild(thead);

  return tr.children;
}

function addTableRow(cells, table) {
  var tr = document.createElement('tr');

  cells.forEach((c) => {
    var td = document.createElement('td');
    td.innerHTML = c;
    tr.appendChild(td);
  });

  table.appendChild(tr);
}

function numberWithCommas(n) {
  return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function numberAsPercentage(n) {
  return `${n.toFixed(1).toString(10)}%`;
}

// graphing... generate graphviz directed graph

function generateDigraph(itemName) {
  let item = searchForComponent(itemName);

  if (item) {
    let graph = item.resources?.map( i => `"${itemName}" -> "${i.name}"` ).flat(2);
    graph.push( item.resources?.map(i => generateDigraph(i.name) ).flat(2));
    return graph.join(' ').replaceAll(',','').trim();
  }

  return undefined;
}

function generateNodeNames(itemName, depth = 0) {
  let item = searchForComponent(itemName);
  let graph = [itemName];

  if (item) {
    graph.push( item.resources.map(i => generateNodeNames(i.name, depth + 1) ));
  }

  return graph.flat(2);
}

function generateNodeList(itemName, nodeStyle = 'shape = box, style = "rounded, filled", fillcolor=slategray1') {
  let nodes =  generateNodeNames(itemName).map( n => `"${n}" [${nodeStyle}, href="/?item=${n}"]`);
  return nodes.join("\n");
}

function generateDotGraph(itemName) {
  let digraph = generateDigraph(itemName);
  let nodeList = generateNodeList(itemName);

  return `
    digraph  {
      graph [fontname = helvetica, splines = ortho ];
      node [fontname = helvetica];
      edge [fontname = helvetica, penwidth = 1, arrowhead = none, arrowtail = normal, dir = both, arrowsize = 0.6 ];

      ${nodeList}

      ${digraph.trim()}
    }
  `;

}

function renderDotGraph(itemName) {
  let viz = new Viz();

  viz.renderSVGElement(generateDotGraph(itemName))
    .then(function(element) {
      document.body.appendChild(element);
      element.id = 'svg_graph';

      element.removeAttribute('height');
      element.removeAttribute('width');
    })
    .catch(error => {
      viz = new Viz();

      console.error(error);
    });
}
